#!/usr/bin/env raku
use lib '../lib';
use CLI::AWS::EC2-Simple;

# first go `aws configure` to populate $HOME/.aws/credentials

#`[
## for cmds list & nuke
my $s = Session.new;
say $s.instance-ids;
say $s.instance-kps;

my $i = Instance.new;

$i.eip-associate;
$i.public-ip-address.say;

$i.connection-str.say;
$i.connect;

#$i.terminate;
say $i.state;
#]


enum CMD <launch state connect>;

sub MAIN(
    CMD   $cmd,                           #= One of <launch state connect>
    Bool :$eip,                         #= Allocates (if needed) and Associates Elastic IP
    Str  :$id, # where /'i-' \w ** 16/,     #= Running InstanceId of form 'i-0785d8bd98b5f458b'
) {
    say $cmd;

#`[[
    my $s = Session.new;
    $s.instance-ids;

    my $focus-id;
#iamerejh fid and id where
    if $id {
        if $id !âˆˆ $s.instance-ids.Set {
            die 'given InstanceId is not present in this Session';
        }
        $focus-id := $id;
    } else {
        $focus-id = slurp './.racl-temp'
    }

    die $focus-id;

    given $cmd {
        when 'launch' {
            my $i = Instance.new(:$s);
            spurt './.racl-temp', $i.id;     # remember last one

            if $eip { $i.eip-associate }
            if $id  {die 'cannot launch an existing Instance'}

            $i.id.say;
        }
    }
#]]
}

